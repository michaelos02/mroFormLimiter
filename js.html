<script>
// Simple and clean JavaScript - no overcomplicated stuff!

document.addEventListener('DOMContentLoaded', function() {
  loadSettings();
  
  // Form submission
  document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings();
  });
  
  // Real-time validation
  document.getElementById('responseLimit').addEventListener('input', validateResponseLimit);
  document.getElementById('closingDate').addEventListener('change', validateDate);
  document.getElementById('closingTime').addEventListener('change', validateDate);
});

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Show selected tab
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

function loadSettings() {
  google.script.run
    .withSuccessHandler(function(settings) {
      if (settings.success) {
        document.getElementById('responseLimit').value = settings.number || '';
        document.getElementById('closingDate').value = settings.date || '';
        document.getElementById('closingTime').value = settings.time || '';
      }
      
      // Show main content, hide loading
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    })
    .withFailureHandler(function(error) {
      showMessage('Error loading settings. Please try again.', true);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    })
    .getSettings();
}

function saveSettings() {
  // Clear previous messages
  hideMessage();
  clearErrors();
  
  // Get values
  const responseLimit = document.getElementById('responseLimit').value.trim();
  const closingDate = document.getElementById('closingDate').value;
  const closingTime = document.getElementById('closingTime').value;
  
  // Validate
  if (!validateForm(responseLimit, closingDate, closingTime)) {
    return;
  }
  
  // Show loading on button
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  // Save
  google.script.run
    .withSuccessHandler(function(result) {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
      
      if (result.success) {
        showMessage(result.message, false);
      } else {
        showMessage(result.error, true);
      }
    })
    .withFailureHandler(function(error) {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
      showMessage('Error saving settings. Please try again.', true);
    })
    .saveSettings(closingDate, closingTime, responseLimit);
}

function validateForm(responseLimit, closingDate, closingTime) {
  let isValid = true;
  
  // Must have at least one limit
  if (!responseLimit && !closingDate) {
    showMessage('Please set at least one limit (response count or closing date).', true);
    return false;
  }
  
  // Validate response limit
  if (responseLimit) {
    const num = parseInt(responseLimit);
    if (isNaN(num) || num < 1 || num > 10000) {
      showError('responseLimitError', 'Must be between 1 and 10,000');
      isValid = false;
    }
  }
  
  // Validate date
  if (closingDate) {
    const selectedDate = new Date(closingDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      showError('closingDateError', 'Date cannot be in the past');
      isValid = false;
    }
    
    // If both date and time, check if in future
    if (closingTime) {
      const dateTime = new Date(closingDate + 'T' + closingTime);
      if (dateTime <= new Date()) {
        showError('closingTimeError', 'Date and time must be in the future');
        isValid = false;
      }
    }
  }
  
  return isValid;
}

function validateResponseLimit() {
  const value = document.getElementById('responseLimit').value.trim();
  const errorElement = document.getElementById('responseLimitError');
  
  if (value === '') {
    hideError(errorElement);
    return;
  }
  
  const num = parseInt(value);
  if (isNaN(num) || num < 1 || num > 10000) {
    showError('responseLimitError', 'Must be between 1 and 10,000');
  } else {
    hideError(errorElement);
  }
}

function validateDate() {
  const date = document.getElementById('closingDate').value;
  const time = document.getElementById('closingTime').value;
  
  clearErrors(['closingDateError', 'closingTimeError']);
  
  if (!date) return;
  
  const selectedDate = new Date(date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (selectedDate < today) {
    showError('closingDateError', 'Date cannot be in the past');
    return;
  }
  
  if (date && time) {
    const dateTime = new Date(date + 'T' + time);
    if (dateTime <= new Date()) {
      showError('closingTimeError', 'Date and time must be in the future');
    }
  }
}

function showMessage(text, isError) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = text;
  messageDiv.style.display = 'block';
  messageDiv.className = isError ? 'error' : 'success';
  
  if (isError) {
    messageDiv.style.backgroundColor = '#fce8e6';
    messageDiv.style.color = '#d93025';
  } else {
    messageDiv.style.backgroundColor = '#e6f4ea';
    messageDiv.style.color = '#137333';
  }
  
  // Auto-hide success messages
  if (!isError) {
    setTimeout(() => hideMessage(), 5000);
  }
}

function hideMessage() {
  document.getElementById('message').style.display = 'none';
}

function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  errorElement.textContent = message;
  errorElement.style.display = 'block';
}

function hideError(errorElement) {
  errorElement.style.display = 'none';
}

function clearErrors(elementIds = ['responseLimitError', 'closingDateError', 'closingTimeError']) {
  elementIds.forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
}
</script>